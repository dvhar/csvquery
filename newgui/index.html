<html>
	<head>
		<link rel="stylesheet" type="text/css" href="style.css"/>
	</head>
	<body>
		<div id=topBar>
			<button id=saveBut>save</button>
			<button id=browseBut>open</button>
			<button id=helpBut>help</button>
			<button id=runBut>run query</button>
			<button id=stopBut>stop query</button>
			<span id=topMessage>query status updates go here...</span>
			<span id=history>&#11164 1/1 &#11166</span>
			<div id=saveDropdown class=topDropdown>
				<span>Save queries on page to their own csv file. A number will be added to file name if more than 1.</span>
				<br>
				<span>To save, type a file path that ends with '.csv' and hit Enter.</span>
				<br>
				<input class=pathinput value="/home/user/">
				<div class=filelist>
					<span class="browsedir updir">&#8592</span>
					<span class=browsedir>/home/user/somedir</span>
					<span class=browsefile>/home/user/file.csv</span>
					<span class=browsefile>/home/user/file with spaces.csv</span>
				</div>
			</div>
			<div id=openDropdown class=topDropdown>
				<span>Double click a file you want to query</span>
				<br>
				<input class=pathinput value="/home/user/">
				<div class=filelist>
					<span class="browsedir updir">&#8592</span>
					<span class=browsedir>/home/user/somedir</span>
					<span class=browsefile>/home/user/file.csv</span>
					<span class=browsefile>/home/user/file with spaces.csv</span>
				</div>
			</div>
		</div>
		<div id=textboxContainer>
			<textarea id=queryTextEntry rows=5 placeholder="Type query here.
Add files to query by clicking the 'open' button above.
If running multiple queries, separate them with a semicolon;
Run queries by pressing the button above or shift-enter"></textarea>
		</div>
		{{ following will be static generated for performance }}
		<br/>
		<div class=singleResult>
			<div class=tableControls>
				<span class=echoQuery>select * from 'example query test.csv'</span>
				<br/>
				<div class=tableDropmenu>
					<span class=controlBut>filter by value</span>
					<div class=tableDropmenuContent>
						<select class=filtername size=2>
							<option onclick="populatefilter(this)">name1</option>
							<option onclick="populatefilter(this)">name2</option>
						</select>
						<select class=filtervalue size=3>
							<option onclick="restoretable(this)">*</option>
							<option onclick="filtertable(this)">val1</option>
							<option onclick="filtertable(this)">val3</option>
						</select>
					</div>
				</div>
				<div class=tableDropmenu>
					<span class=controlBut>hide columns</span>
					<div class=tableDropmenuContent>
						<select size=2>
							<option>name1</option>
							<option>name2</option>
						</select>
					</div>
				</div>
				<span class=controlBut>Rows: 2</span>
			</div>
			<div class=resultHeadDiv>
				<table class=resultHead>
					<thead>
						<tr class=colnames><th onclick="sorttable(this)">name1</th><th onclick="sorttable(this)">name2</th></tr>
						<tr class=coltypes><td>type1</td><td>type2</td></tr>
					</thead>
				</table>
			</div>
			<div class=resultBodyDiv>
				<table class=resultBody>
					<tbody>
						<tr><td>val1</td><td>val2</td></tr>
						<tr><td>val3</td><td>val4 is wider to test resizing</td></tr>
					</tbody>
				</table>
			</div>
		</div>
	</body>
</html>

<script>
	
function getidx(arr, comp){
	for (var i in arr){
			if (comp(arr[i]))
				return i;
		}
	return 0;
}
function restoretable(opt){
	let res = opt.closest('.singleResult');
	let tbody = res.querySelector('tbody');
	tbody.innerText = '';
	res.fulldata.rows.forEach(row => tbody.appendChild(row));
}
function filtertable(opt){
	let res = opt.closest('.singleResult');
	let idx = getidx(Array.from(res.querySelector('.filtername').children), (o)=>o.selected);
	let tbody = res.querySelector('tbody');
	tbody.innerText = '';
	res.fulldata.rows.forEach(row => {
		if (row.children[idx].textContent == opt.textContent)
			tbody.appendChild(row);
	});
}
function populatefilter(opt){
	let res = opt.closest('.singleResult');
	let idx = getidx(res.fulldata.cols, c=>{return c.textContent == opt.textContent});
	let filtervalues = res.querySelector('.filtervalue');
	filtervalues.textContent = '';
	filtervalues.size = res.fulldata.rows.length+1;
	let newopt = document.createElement('option');
	newopt.textContent = '*';
	newopt.onclick = ()=>restoretable(newopt);
	filtervalues.appendChild(newopt);
	// todo: sorted unique values
	res.fulldata.rows.forEach(r => {
		let newopt = document.createElement('option');
		newopt.textContent = r.children[idx].textContent;
		newopt.onclick = ()=>filtertable(newopt);
		filtervalues.appendChild(newopt);
	});
}

function sorttable(th){
	const getCellValue = (tr, idx) => tr.children[idx].innerText || tr.children[idx].textContent;
	const comparer = (idx, asc) => (a, b) => ((v1, v2) => 
		v1 !== '' && v2 !== '' && !isNaN(v1) && !isNaN(v2) ? v1 - v2 : v1.toString().localeCompare(v2)
		)(getCellValue(asc ? a : b, idx), getCellValue(asc ? b : a, idx));
	let idx = Array.from(th.parentNode.children).indexOf(th);
	let tbody = th.closest('.singleResult').querySelector('tbody');
	Array.from(tbody.querySelectorAll('tr'))
		.sort(comparer(idx, this.asc = !this.asc))
		.forEach(tr => tbody.appendChild(tr) );
}

function resize(res){
	let tbody = res.querySelector('tbody');
	let thead = res.querySelector('thead');
	let theaddiv = thead.closest('.resultHeadDiv');
	let tbodydiv = tbody.closest('.resultBodyDiv');
	//get header table and body table cells to line up and scroll when needed
	if (tbody.childNodes.length > 1 && tbody.childNodes[1].childNodes.length > 0){
		let trow = tbody.childNodes[1].childNodes
		for (let i in trow){
			let bcell = trow[i];
			let hcell = thead.childNodes[1].childNodes[i];
			if (bcell.offsetWidth && hcell.offsetWidth){
				let newWidth = Math.max(bcell.offsetWidth, hcell.offsetWidth);
				bcell.style.minWidth = hcell.style.minWidth = `${newWidth+1}px`;
			}
		}
	}
	let num = (tbody.offsetHeight <= tbodydiv.offsetHeight) ? 4:15;
	theaddiv.style.maxWidth = tbodydiv.style.maxWidth =  `${Math.min(tbody.offsetWidth+num,window.innerWidth)}px`;
}

function postProcess(res){
	resize(res);
	let tbody = res.querySelector('tbody');
	let thead = res.querySelector('thead');
	let theaddiv = thead.closest('.resultHeadDiv');
	let tbodydiv = tbody.closest('.resultBodyDiv');
	tbodydiv.addEventListener('scroll',function(){ theaddiv.scrollLeft = tbodydiv.scrollLeft; });
	// make backup of orig data for filtering and restoring
	res.fulldata = {
		rows: Array.from(tbody.children),
		cols: Array.from(res.querySelector('.colnames').children)
	};
	// initialize menus statically on backend
}
document.querySelectorAll('.singleResult').forEach(res => postProcess(res));
</script>
